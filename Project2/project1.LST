A51 MACRO ASSEMBLER  PROJECT1                                                             03/28/2014 11:07:49 PAGE     1


MACRO ASSEMBLER A51 V8.02b
OBJECT MODULE PLACED IN project1.OBJ
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE project1.a51 SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     ; ----- Kelby Sapien
                       2     ; ----- Project 2
  00A7                 3                     FLAG BIT P2.7
  0090                 4                     LED EQU P1
                       5                     
0000                   6                     ORG 0000H
0000 020016            7                     LJMP MAIN0
                       8                     
0003                   9                     ORG 0003H
0003 C2A7             10                     CLR FLAG
0005 32               11                     RETI
                      12                     
0013                  13                     ORG 0013H
0013 D2A7             14                     SETB FLAG
0015 32               15                     RETI
0016 758901           16     MAIN0:  MOV TMOD, #01H ; TIMER 0 MODE 1
0019 7590FF           17     MAIN:   MOV LED, #0FFH
001C D288             18                     SETB TCON.0
001E C2A7             19                     CLR FLAG
                      20                     ;MOV TMOD, #01H ;TIMER 0 MODE 1
                      21                     
0020 308005           22     AGAIN:  JNB P0.0, CHECK_COUNT   ; JUMP if P0.0 is low, otherwise do bouncing cat
0023 1200BD           23                     LCALL BOUNCING                    ; lower pins have higher priority
0026 80F1             24                     SJMP MAIN
                      25                     
0028                  26     CHECK_COUNT:                                                                               
                                                                                                              
0028 308105           27                     JNB P0.1, CHECK_DB  ; JUMP if P0.1 is low, otherwise do counting
002B 12006F           28                     LCALL COUNT
002E 80E9             29                     SJMP MAIN                 ; AT EACH BRANCH, YOU WANT TO GO BACK TO AGAIN AN
                             D CHECK FOR PIN PRIORITY
                      30     
0030                  31     CHECK_DB:
0030 308205           32                     JNB P0.2, CHECK_CYC ; JUMP if P0.2 is low, otherwise do double_bounce
0033 120084           33                     LCALL DOUBLE_BOUNCE
0036 80E1             34                     SJMP MAIN
                      35     
0038                  36     CHECK_CYC: 
0038 308305           37                     JNB P0.3, ERR   ; JUMP if P0.3 is low to error state, otherwise do cyclic m
                             ode
003B 12004F           38                     LCALL CYCLIC
003E 80D9             39                     SJMP MAIN
                      40     
0040                  41     ERR:    ; IF ALL PINS ARE OFF, THEN JUST FLASH THEM                                        
                                                                                                                                       
0040 7590FF           42                     MOV LED,#0FFH
0043 1200DC           43                     LCALL DELAY
0046 759000           44                     MOV LED, #0
0049 1200DC           45                     LCALL DELAY
004C 020019           46                     LJMP MAIN
                      47     
                      48     ; ---- CYCLIC MODE
004F                  49     CYCLIC: 
                      50                     ;JB P0.0, JUMP2_BOUNCE ; RETURN TO PREVIOUS MODE IF PRESSED
                      51                     ;JB P0.1, COUNT
                      52                     ;JB P0.2, DOUBLE_BOUNCE
                      53                     ;JNB P0.3, CYCLIC_DONE  ; replaced with the interrupt
004F 20A719           54                     JB FLAG, CYCLIC_DONE
A51 MACRO ASSEMBLER  PROJECT1                                                             03/28/2014 11:07:49 PAGE     2

                      55                     ;MOV A, #0H
0052 759000           56                     MOV LED, #0
0055 1200DC           57                     LCALL DELAY
0058 7480             58                     MOV A, #80H
005A 7D08             59                     MOV R5, #8
005C                  60     AGAIN2:         
                      61                     ;JB P0.0, BOUNCING ; RETURN TO PREVIOUS MODE IF PRESSED
                      62                     ;JB P0.1, COUNT
                      63                     ;JB P0.2, DOUBLE_BOUNCE
                      64                     ;JNB P0.3, CYCLIC_DONE ; REPLACED WITH INTERRUPT FLAG
005C 20A70C           65                     JB FLAG, CYCLIC_DONE
005F F590             66                     MOV LED, A
0061 1200DC           67                     LCALL DELAY
0064 FE               68                     MOV R6, A
0065 03               69                     RR A
0066 4E               70                     ORL A, R6
                      71                     ;MOV LED, A
                      72                     ;LCALL DELAY
0067 DDF3             73                     DJNZ R5, AGAIN2
0069 80E4             74                     SJMP CYCLIC
                      75     
006B 22               76     CYCLIC_DONE: RET
                      77     
006C                  78     JUMP2_BOUNCE:
006C 0200BD           79                     LJMP BOUNCING
                      80     
                      81     ;---- COUNTING MODE
006F                  82     COUNT:  
                      83                     ;JB P0.0, BOUNCING
006F 20A711           84                     JB FLAG, C_DONE
0072 759000           85             MOV LED, #0
0075 7BFF             86                     MOV R3, #0FFH
0077                  87     DO_AGAIN:
                      88                     ;JB P0.0, BOUNCING
                      89                     ;JNB P0.1, C_DONE
0077 20A709           90                     JB FLAG, C_DONE
                      91                     ;JNB P0.3, ERR
007A 1200DC           92             LCALL DELAY             
007D 0590             93                     INC LED
007F DBF6             94                     DJNZ R3, DO_AGAIN
0081 8096             95                     SJMP MAIN
0083 22               96     C_DONE: RET
                      97     
                      98     
                      99     ; --- DOUBLE BOUNCE
                     100     ; BE CAREFUL, R1-R3 ARE USED BY DELAY FUNCTION
                     101     ; KEPT GETTING ERRORS B/C OF IT
                     102     ; fix overlap by calling two different loops
0084                 103     DOUBLE_BOUNCE:
                     104                     ;JB P0.0, BOUNCING
                     105                     ;JB P0.1, COUNT ; JUMP BACK TO COUNTING MODE IF P0.1 IS HIGH
                     106                     ;JNB P0.2, D_BOUNCE_DONE
0084 20A735          107                     JB FLAG, D_BOUNCE_DONE
0087 7C80            108                     MOV R4, #80H ; 1000 0000
0089 7D01            109                     MOV R5, #01H ; 0000 0001
008B 7E03            110                     MOV R6, #3 ; COUNTER
                     111             
008D EC              112                     MOV A, R4 ; store initial R1 VAL into A = 1000 0000
                     113                     
008E 4D              114                     ORL A, R5 ; A = 1000 0001
008F F590            115                     MOV LED, A ; DISPLAYS IN LED
0091 1200DC          116                     LCALL DELAY
                     117                     
0094                 118     PART1:
                     119                     ;JB P0.0, BOUNCING
                     120                     ;JB P0.1, COUNT
A51 MACRO ASSEMBLER  PROJECT1                                                             03/28/2014 11:07:49 PAGE     3

                     121                     ;JNB P0.2, D_BOUNCE_DONE
0094 20A725          122                     JB FLAG, D_BOUNCE_DONE          
                     123                     ;CLR A
0097 EC              124                     MOV A, R4 ; A = 1000 0000
0098 03              125                     RR A   ;        A = 0100 0000
0099 FC              126                     MOV R4, A ;R1 = 0100 0000
009A ED              127                     MOV A, R5 ; A = 0000 0001
009B 23              128                     RL A      ; A = 0000 0010
009C FD              129                     MOV R5, A ;R2 = 0000 0010
009D 4C              130                     ORL A, R4 ; R1 OR R2 A = 0100 0010 FIRST RUN
                     131                     ;CJNE A,   ; jump when 10 or 0001 1000
009E F590            132                     MOV LED, A ; DISPLAY
00A0 1200DC          133                     LCALL DELAY
00A3 DEEF            134                     DJNZ R6, PART1
00A5 7E02            135                     MOV R6, #2 ; RESET COUNTER
00A7 8000            136                     SJMP PART2
                     137     
                     138                     
00A9                 139     PART2:
                     140                     ;JB P0.0, BOUNCING
                     141                     ;JB P0.1, COUNT
                     142                     ;JNB P0.2, D_BOUNCE_DONE        
00A9 20A710          143                     JB FLAG, D_BOUNCE_DONE
                     144                     ;CLR A
00AC EC              145                     MOV A, R4 ; A = 1000 0000
00AD 23              146                     RL A   ;        A = 0100 0000
00AE FC              147                     MOV R4, A ;R1 = 0100 0000
00AF ED              148                     MOV A, R5 ; A = 0000 0001
00B0 03              149                     RR A      ; A = 0000 0010
00B1 FD              150                     MOV R5, A ;R2 = 0000 0010
00B2 4C              151                     ORL A, R4 ; R1 OR R2 A = 0100 0010 FIRST RUN
                     152                     ;CJNE A,   ; jump when 10 or 0001 1000
00B3 F590            153                     MOV LED, A ; DISPLAY
00B5 1200DC          154                     LCALL DELAY
00B8 DEEF            155                     DJNZ R6, PART2
00BA 80C8            156                     SJMP DOUBLE_BOUNCE              
                     157                     
                     158     
00BC 22              159     D_BOUNCE_DONE:  RET
                     160     
                     161     ; -- BOUNCING
00BD                 162     BOUNCING:
00BD 7401            163                     MOV A, #01H
00BF 7808            164                     MOV R0, #8
00C1                 165     LEFT:   ;JNB P0.0, B_DONE          ; RETURN IF DONE
00C1 20A717          166                     JB FLAG, B_DONE
00C4 03              167                     RR A
00C5 F590            168                     MOV LED, A
00C7 1200DC          169                     LCALL DELAY
00CA D8F5            170                     DJNZ R0, LEFT ; USE A LOOP TO MOVE 7 POSITIONS
00CC 7806            171                     MOV R0, #6    ; RESET COUNTER
00CE                 172     RIGHT:  ;JNB P0.0, B_DONE          ; RETURN IF DONE
00CE 20A70A          173                     JB FLAG, B_DONE
00D1 23              174                     RL A
00D2 F590            175                     MOV LED, A
                     176                     
00D4 1200DC          177                     LCALL DELAY
00D7 D8F5            178                     DJNZ R0, RIGHT
00D9 80E2            179                     SJMP BOUNCING ; REPEAT THE WHOLE SEQUENCE AGAIN
00DB 22              180     B_DONE: RET
                     181     
                     182     
                     183     ; -----------DELAY FUNCTION
00DC                 184     DELAY:
                     185                     ;MOV R7, #10
                     186                     ;MOV R3, #220
A51 MACRO ASSEMBLER  PROJECT1                                                             03/28/2014 11:07:49 PAGE     4

                     187     
00DC                 188     HALF_SEC_CHK:                            ; LOWER PINS HAVE HIGHER PRIORITY
00DC 308404          189                     JNB P0.4, ONE_SEC_CHK   
00DF 7F0A            190                     MOV R7, #10  
00E1 8019            191                     SJMP DLY
                     192     
00E3                 193     ONE_SEC_CHK:    
00E3 308504          194                     JNB P0.5, ONE_HALF_CHK  
00E6 7F14            195                     MOV R7, #20       
00E8 8012            196                     SJMP DLY
                     197     
00EA                 198     ONE_HALF_CHK:   
00EA 308604          199                     JNB P0.6, TWO_SEC_CHK   
00ED 7F1E            200                     MOV R7, #30  
00EF 800B            201                     SJMP DLY
00F1                 202     TWO_SEC_CHK:    
00F1 308704          203                     JNB P0.7, ERR_DELAY     
00F4 7F28            204                     MOV R7, #40       
00F6 8004            205                     SJMP DLY
                     206     
00F8                 207     ERR_DELAY:
00F8 7F0A            208                     MOV R7, #10
                     209                     ;LCALL DLY
00FA 8000            210                     SJMP DLY
                     211                      
                     212     
00FC                 213     DLY:
                     214     
                     215     ; Calculate the initial counting value x:
                     216     ; In At89C51RD2 1 machine cycle equals 12 crystal cycles:
                     217     ; (12/11.0592MHz)(2^16-x)=50ms
                     218     ; solve the equation for x, we obtain:
                     219     ; x=2^16-50ms*11.0592MHz/12=19456=4C00H
                     220     
00FC 758A00          221     WAIT: MOV TL0, #0;load initial counting value
00FF 758C4C          222           MOV TH0, #4CH;
0102 D28C            223           SETB TR0;turn on T0
0104 308DFD          224     HERE: JNB TF0, HERE;wait for timer 0 to overflow
0107 C28C            225           CLR TR0 ;turn off timer 0
0109 C28D            226           CLR TF0 ;clear TF0 as interrupt is not used, 
                     227             ;it will not be cleared by hardware.
010B DFEF            228           DJNZ R7, WAIT
010D 22              229               RET
                     230           END
A51 MACRO ASSEMBLER  PROJECT1                                                             03/28/2014 11:07:49 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

AGAIN. . . . . . .  C ADDR   0020H   A   
AGAIN2 . . . . . .  C ADDR   005CH   A   
BOUNCING . . . . .  C ADDR   00BDH   A   
B_DONE . . . . . .  C ADDR   00DBH   A   
CHECK_COUNT. . . .  C ADDR   0028H   A   
CHECK_CYC. . . . .  C ADDR   0038H   A   
CHECK_DB . . . . .  C ADDR   0030H   A   
COUNT. . . . . . .  C ADDR   006FH   A   
CYCLIC . . . . . .  C ADDR   004FH   A   
CYCLIC_DONE. . . .  C ADDR   006BH   A   
C_DONE . . . . . .  C ADDR   0083H   A   
DELAY. . . . . . .  C ADDR   00DCH   A   
DLY. . . . . . . .  C ADDR   00FCH   A   
DOUBLE_BOUNCE. . .  C ADDR   0084H   A   
DO_AGAIN . . . . .  C ADDR   0077H   A   
D_BOUNCE_DONE. . .  C ADDR   00BCH   A   
ERR. . . . . . . .  C ADDR   0040H   A   
ERR_DELAY. . . . .  C ADDR   00F8H   A   
FLAG . . . . . . .  B ADDR   00A0H.7 A   
HALF_SEC_CHK . . .  C ADDR   00DCH   A   
HERE . . . . . . .  C ADDR   0104H   A   
JUMP2_BOUNCE . . .  C ADDR   006CH   A   
LED. . . . . . . .  D ADDR   0090H   A   
LEFT . . . . . . .  C ADDR   00C1H   A   
MAIN . . . . . . .  C ADDR   0019H   A   
MAIN0. . . . . . .  C ADDR   0016H   A   
ONE_HALF_CHK . . .  C ADDR   00EAH   A   
ONE_SEC_CHK. . . .  C ADDR   00E3H   A   
P0 . . . . . . . .  D ADDR   0080H   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
PART1. . . . . . .  C ADDR   0094H   A   
PART2. . . . . . .  C ADDR   00A9H   A   
RIGHT. . . . . . .  C ADDR   00CEH   A   
TCON . . . . . . .  D ADDR   0088H   A   
TF0. . . . . . . .  B ADDR   0088H.5 A   
TH0. . . . . . . .  D ADDR   008CH   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TWO_SEC_CHK. . . .  C ADDR   00F1H   A   
WAIT . . . . . . .  C ADDR   00FCH   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
